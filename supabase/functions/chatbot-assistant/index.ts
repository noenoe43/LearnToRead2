
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.43.0";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {

  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Initialize the Supabase client
    const supabaseUrl = Deno.env.get("SUPABASE_URL") || "";
    const supabaseAnonKey = Deno.env.get("SUPABASE_ANON_KEY") || "";
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const { message, userId, contextData, pageContext } = await req.json();

    console.log("Chatbot request received:", { message, userId, contextData, pageContext });

    // Process the message based on context
    let response = "";
    let suggestions = [];

    // More detailed responses for different pages
    if (message.toLowerCase().includes("ayuda") || message.toLowerCase().includes("qu√© es") || message.toLowerCase().includes("para que sirve") || message.toLowerCase().includes("secci√≥n") || message.toLowerCase().includes("seccion")) {
      if (pageContext && pageContext.includes("perfil")) {
        // Specific explanations for profile page sections
        if (message.toLowerCase().includes("avatar") || message.toLowerCase().includes("foto")) {
          response = "üñºÔ∏è **Avatar/Foto de Perfil**: Esta secci√≥n te permite personalizar tu imagen de perfil. Puedes subir una foto propia haciendo clic en el √≠cono de subida junto a tu avatar. Tu avatar aparecer√° en toda la plataforma y te ayuda a personalizar tu experiencia de aprendizaje.";
        } else if (message.toLowerCase().includes("estad√≠sticas") || message.toLowerCase().includes("estadisticas")) {
          response = "üìä **Mis Estad√≠sticas**: Esta secci√≥n muestra tu rendimiento general:\n\n‚Ä¢ **Ejercicios completados**: Total de actividades que has terminado\n‚Ä¢ **Puntuaciones perfectas**: Cu√°ntas veces has obtenido el puntaje m√°ximo\n‚Ä¢ **Tiempo jugando**: Cu√°nto tiempo has dedicado a practicar\n‚Ä¢ **Categor√≠a favorita**: El tipo de ejercicio que m√°s practicas\n‚Ä¢ **Progreso por categor√≠a**: Tu rendimiento promedio en cada tipo de ejercicio (dictado, rimas, lectura, memoria)";
        } else if (message.toLowerCase().includes("racha")) {
          response = "üî• **Mi Racha**: Esta secci√≥n te motiva a practicar diariamente:\n\n‚Ä¢ **D√≠as seguidos**: Cu√°ntos d√≠as consecutivos has entrado a LearnToRead\n‚Ä¢ **Indicadores visuales**: Los c√≠rculos muestran tu progreso semanal\n‚Ä¢ **Puntos acumulados**: Tu total de puntos ganados\n‚Ä¢ **Consejos**: Te recuerda que la constancia es clave para el aprendizaje\n\n¬°La racha se mantiene entrando al menos una vez por d√≠a!";
        } else if (message.toLowerCase().includes("ejercicios problem√°ticos") || message.toLowerCase().includes("problematicos") || message.toLowerCase().includes("practicar")) {
          response = "‚ö†Ô∏è **Ejercicios que necesitas practicar m√°s**: Esta secci√≥n identifica autom√°ticamente las √°reas donde necesitas mejorar:\n\n‚Ä¢ Muestra ejercicios donde obtuviste puntuaciones bajas\n‚Ä¢ Te da la fecha del √∫ltimo intento\n‚Ä¢ Incluye un bot√≥n directo para volver a practicar\n‚Ä¢ Te ayuda a enfocar tu tiempo de estudio en lo que m√°s necesitas";
        } else if (message.toLowerCase().includes("test") || message.toLowerCase().includes("diagn√≥stico") || message.toLowerCase().includes("diagnostico")) {
          response = "üìã **Resultados de mi Test de Diagn√≥stico**: Esta secci√≥n muestra tu evaluaci√≥n inicial:\n\n‚Ä¢ **√Åreas evaluadas**: Lectura, escritura, matem√°ticas y memoria\n‚Ä¢ **Porcentajes por √°rea**: Tu nivel en cada habilidad\n‚Ä¢ **Recomendaciones**: Qu√© √°reas necesitas trabajar m√°s\n‚Ä¢ **Ejercicios sugeridos**: Bot√≥n para ir directamente a las actividades recomendadas\n\nEste test solo se puede hacer una vez por semana para ver tu progreso real.";
        } else if (message.toLowerCase().includes("calendario")) {
          response = "üìÖ **Mi Calendario de Actividad**: Esta secci√≥n visual muestra tu constancia:\n\n‚Ä¢ **D√≠as marcados**: Cada d√≠a que has usado LearnToRead aparece destacado\n‚Ä¢ **Motivaci√≥n visual**: Te ayuda a ver tu progreso a lo largo del tiempo\n‚Ä¢ **Recordatorio**: Te anima a practicar todos los d√≠as\n‚Ä¢ **Historial**: Puedes ver qu√© tan activo has sido en semanas y meses anteriores";
        } else if (message.toLowerCase().includes("logros") || message.toLowerCase().includes("logro")) {
          response = "üèÜ **Mis Logros**: Esta secci√≥n gamifica tu aprendizaje:\n\n‚Ä¢ **Insignias desbloqueadas**: Logros que ya has conseguido (aparecen en color)\n‚Ä¢ **Insignias por desbloquear**: Objetivos por alcanzar (aparecen en gris)\n‚Ä¢ **Tipos de logros**: \n  - Rachas diarias (7, 14 d√≠as)\n  - Ejercicios completados (20, 50)\n  - Maestr√≠as en categor√≠as espec√≠ficas\n‚Ä¢ **Motivaci√≥n**: Te dan objetivos claros para seguir mejorando";
        } else if (message.toLowerCase().includes("puntos") || message.toLowerCase().includes("nivel")) {
          response = "‚≠ê **Sistema de Puntos y Niveles**: En tu perfil puedes ver:\n\n‚Ä¢ **Puntos actuales**: Total de puntos acumulados\n‚Ä¢ **Nivel actual**: Tu nivel basado en tus puntos\n‚Ä¢ **Progreso al siguiente nivel**: Barra que muestra cu√°nto te falta\n‚Ä¢ **C√≥mo ganar puntos**:\n  - Completar ejercicios (+puntos por rendimiento)\n  - Mantener racha diaria (+50 puntos por d√≠a)\n  - Obtener puntuaciones perfectas (+puntos extra)";
        } else {
          response = "üì± **P√°gina de Perfil - Todas las Secciones**:\n\nüñºÔ∏è **Avatar**: Personaliza tu foto de perfil\nüìä **Estad√≠sticas**: Ve tu rendimiento general y por categor√≠as\nüî• **Racha Diaria**: Rastrea tu constancia d√≠a a d√≠a\n‚ö†Ô∏è **Ejercicios Problem√°ticos**: Identifica qu√© necesitas practicar m√°s\nüìã **Test de Diagn√≥stico**: Resultados de tu evaluaci√≥n inicial\nüìÖ **Calendario**: Historial visual de tu actividad\nüèÜ **Logros**: Insignias y objetivos desbloqueados\n‚≠ê **Puntos y Niveles**: Tu progreso gamificado\n\n¬øSobre qu√© secci√≥n espec√≠fica te gustar√≠a saber m√°s detalles?";
        }
      } else if (pageContext && pageContext.includes("Nosotros")) {
        response = "En la p√°gina 'Sobre Nosotros' puedes encontrar informaci√≥n sobre nuestra misi√≥n educativa, c√≥mo ayudamos a ni√±os con dislexia, nuestro enfoque pedag√≥gico basado en m√©todos multisensoriales, y conocer al equipo detr√°s de LearnToRead. Tambi√©n explicamos los beneficios de nuestra plataforma y c√≥mo puedes contactarnos si tienes preguntas adicionales.";
      } else if (pageContext && pageContext.includes("ejercicios")) {
        response = "En la secci√≥n de ejercicios encontrar√°s actividades interactivas dise√±adas espec√≠ficamente para ni√±os con dislexia. Incluyen ejercicios de conciencia fonol√≥gica, discriminaci√≥n visual de letras, formaci√≥n de palabras y comprensi√≥n lectora. Cada ejercicio se adapta al nivel del usuario y ofrece retroalimentaci√≥n inmediata.";
      } else if (pageContext && pageContext.includes("biblioteca")) {
        response = "Nuestra biblioteca contiene libros y textos adaptados para personas con dislexia, con tipograf√≠as especiales, mayor espaciado entre l√≠neas y palabras, y un dise√±o que facilita la lectura. Los textos est√°n organizados por nivel de dificultad y tem√°ticas para que encuentres exactamente lo que necesitas.";
      } else if (pageContext && pageContext.includes("donaci√≥n")) {
        response = "En esta p√°gina puedes contribuir al desarrollo de LearnToRead mediante donaciones. Tu apoyo nos ayuda a mantener la plataforma gratuita, desarrollar nuevos ejercicios y funcionalidades, y llegar a m√°s ni√±os con dislexia. Cada donaci√≥n, sin importar el monto, marca la diferencia. Puedes elegir entre diferentes cantidades o establecer una donaci√≥n personalizada. ¬°Gracias por ayudarnos a transformar vidas a trav√©s de la educaci√≥n!";
      } else {
        response = "LearnToRead es una aplicaci√≥n educativa dise√±ada para ayudar a ni√±os con dislexia a mejorar sus habilidades de lectura y escritura mediante juegos y ejercicios interactivos. ¬øSobre qu√© secci√≥n espec√≠fica te gustar√≠a saber m√°s?";
      }
    } else if (message.toLowerCase().includes("donaci√≥n") || message.toLowerCase().includes("donar") || message.toLowerCase().includes("contribuir") || message.toLowerCase().includes("apoyo")) {
      response = "¬°Gracias por tu inter√©s en apoyar LearnToRead! Las donaciones son fundamentales para mantener nuestra plataforma gratuita y accesible para todos los ni√±os con dislexia. Tu contribuci√≥n nos permite: \n\n‚Ä¢ Desarrollar nuevos ejercicios y actividades\n‚Ä¢ Mejorar constantemente la plataforma\n‚Ä¢ Mantener el servicio gratuito para familias que lo necesitan\n‚Ä¢ Investigar y aplicar las √∫ltimas metodolog√≠as educativas\n‚Ä¢ Expandir nuestro alcance a m√°s comunidades\n\nPuedes elegir el monto que desees donar, desde peque√±as contribuciones hasta montos mayores. Cada euro cuenta y nos acerca m√°s a nuestro objetivo de ayudar a m√°s ni√±os. ¬øTe gustar√≠a saber m√°s sobre c√≥mo usar el formulario de donaci√≥n?";
    } else if (message.toLowerCase().includes("formulario") && (message.toLowerCase().includes("donaci√≥n") || pageContext && pageContext.includes("donaci√≥n"))) {
      response = "El formulario de donaci√≥n es muy sencillo de usar:\n\n1. **Selecciona un monto**: Puedes elegir entre las opciones predefinidas (‚Ç¨5, ‚Ç¨10, ‚Ç¨25, ‚Ç¨50) o escribir tu propia cantidad en 'Otro monto'\n\n2. **Informaci√≥n personal**: Completa tu nombre y email para el recibo de donaci√≥n\n\n3. **Mensaje opcional**: Si quieres, puedes dejarnos un mensaje especial\n\n4. **Procesar pago**: Haz clic en 'Donar ahora' para proceder al pago seguro\n\nTodos los pagos se procesan de forma segura a trav√©s de Stripe. Recibir√°s un recibo por email y tu donaci√≥n nos ayudar√° inmediatamente a seguir desarrollando la plataforma.";
    } else if (message.toLowerCase().includes("racha") || message.toLowerCase().includes("d√≠as seguidos") || message.toLowerCase().includes("streak")) {
      response = "¬°La racha diaria es una forma genial de mantenerte motivado! Funciona as√≠:\n\nüî• **C√≥mo funciona**: Cada d√≠a que entres a LearnToRead, tu racha aumenta en 1\n\nüìÖ **Mantener la racha**: Solo necesitas iniciar sesi√≥n una vez al d√≠a para mantenerla\n\n‚ö° **Beneficios**: \n‚Ä¢ Ganas puntos extra por mantener tu racha\n‚Ä¢ Desbloqueas logros especiales\n‚Ä¢ Te motiva a practicar regularmente\n\n‚ùå **Perder la racha**: Si pasas un d√≠a completo sin entrar, se reinicia a 0\n\n‚ú® **Consejo**: ¬°Intenta entrar todos los d√≠as, aunque sea por unos minutos! La constancia es clave para el aprendizaje. Tu racha actual puedes verla en tu perfil personal.";
    } else if (message.toLowerCase().includes("dislexia")) {
      response = "La dislexia es una dificultad de aprendizaje que afecta principalmente la capacidad de leer y procesar el lenguaje escrito. Las personas con dislexia suelen tener dificultades para reconocer las letras, relacionar sonidos con s√≠mbolos o entender secuencias. LearnToRead est√° especialmente dise√±ado para ayudar a ni√±os con dislexia mediante ejercicios adaptados que fortalecen estas habilidades espec√≠ficas.";
    } else if (message.toLowerCase().includes("ejercicio") || message.toLowerCase().includes("actividad")) {
      if (contextData?.currentExercise) {
        response = `Est√°s trabajando en el ejercicio "${contextData.currentExercise.title}". Este tipo de ejercicios ayuda a desarrollar tu ${contextData.currentExercise.type === 'fonol√≥gico' ? 'conciencia fonol√≥gica y reconocimiento de sonidos' : contextData.currentExercise.type === 'visual' ? 'discriminaci√≥n visual y reconocimiento de letras' : 'habilidades de comprensi√≥n lectora'}. ¬øEn qu√© parte necesitas ayuda?`;
      } else {
        response = "Tenemos varios tipos de ejercicios dise√±ados para ayudarte con diferentes aspectos de la lectura y escritura. Incluyen actividades de conciencia fonol√≥gica, discriminaci√≥n visual, formaci√≥n de palabras y comprensi√≥n lectora. Cada uno est√° dise√±ado para ser divertido a la vez que educativo. ¬øQuieres que te recomiende algunos ejercicios?";
        try {
          const { data: exercises } = await supabase
              .from('exercises')
              .select('id, title, type, difficulty')
              .limit(3);

          if (exercises && exercises.length > 0) {
            suggestions = exercises.map(ex => ({
              id: ex.id,
              title: ex.title,
              type: ex.type === 'fonol√≥gico' ? 'Conciencia Fonol√≥gica' : ex.type === 'visual' ? 'Discriminaci√≥n Visual' : 'Comprensi√≥n Lectora',
              difficulty: ex.difficulty === 'easy' ? 'F√°cil' : ex.difficulty === 'medium' ? 'Intermedio' : 'Avanzado'
            }));
          }
        } catch (error) {
          console.error("Error fetching exercise suggestions:", error);
        }
      }
    } else if (message.toLowerCase().includes("progreso") || message.toLowerCase().includes("avance")) {
      response = "Puedes ver tu progreso completo en tu perfil personal. All√≠ encontrar√°s gr√°ficos detallados de tu avance, ejercicios completados, tiempo dedicado al aprendizaje, puntos acumulados y tu racha diaria. Tambi√©n podr√°s ver qu√© habilidades has mejorado m√°s y cu√°les necesitan m√°s pr√°ctica.";
    } else if (message.toLowerCase().includes("perfil")) {
      response = "En tu perfil personal puedes ver todas tus estad√≠sticas de aprendizaje, personalizar tu avatar, ajustar tus preferencias de aprendizaje y revisar tu plan personalizado. Es tu espacio individual donde puedes hacer seguimiento de todo tu progreso en la plataforma. ¬øTe gustar√≠a que te dirija a tu perfil?";
    } else if (message.toLowerCase().includes("puntos") || message.toLowerCase().includes("calificaci√≥n") || message.toLowerCase().includes("puntaje")) {
      response = "En LearnToRead ganar√°s puntos por completar ejercicios, mantener una racha diaria de estudio y alcanzar nuevos logros. Los puntos te permiten desbloquear nuevas funciones, personalizar tu avatar con elementos especiales y avanzar en el ranking de la comunidad. ¬°Es una forma divertida de mantenerte motivado en tu aprendizaje!";
    } else if (contextData?.exerciseCompleted) {
      const score = contextData.score || 0;
      const maxScore = contextData.maxScore || 10;
      const percentage = Math.round((score / maxScore) * 100);

      if (percentage >= 90) {
        response = `¬°Excelente trabajo! Has obtenido ${score}/${maxScore} puntos (${percentage}%). ¬°Has ganado 100 puntos extra! Tu esfuerzo est√° dando frutos y est√°s avanzando r√°pidamente en tu aprendizaje.`;
      } else if (percentage >= 70) {
        response = `¬°Buen trabajo! Has obtenido ${score}/${maxScore} puntos (${percentage}%). Est√°s en buen camino. Sigue practicando y ver√°s c√≥mo mejoras cada vez m√°s.`;
      } else {
        response = `Has obtenido ${score}/${maxScore} puntos (${percentage}%). No te desanimes, el aprendizaje es un proceso. Te recomiendo repasar los conceptos b√°sicos y volver a intentarlo. ¬°Con pr√°ctica lo conseguir√°s!`;
      }
    } else if (message.toLowerCase().includes("equipo") || message.toLowerCase().includes("creadores")) {
      response = "LearnToRead fue creado por un equipo de especialistas en educaci√≥n, psicopedagogos expertos en dislexia, dise√±adores de experiencia de usuario y desarrolladores. Nuestra directora educativa, Shirley Noelia, es especialista en Pedagog√≠a Terap√©utica con m√°s de 15 a√±os de experiencia ayudando a ni√±os con dificultades de aprendizaje. Puedes conocer m√°s sobre nuestro equipo en la secci√≥n 'Sobre Nosotros'.";
    } else if (message.toLowerCase().includes("m√©todo") || message.toLowerCase().includes("enfoque") || message.toLowerCase().includes("metodolog√≠a")) {
      response = "Nuestro enfoque se basa en m√©todos multisensoriales que combinan est√≠mulos visuales, auditivos y kinest√©sicos para reforzar el aprendizaje. Utilizamos t√©cnicas como la instrucci√≥n fon√©tica sistem√°tica, la repetici√≥n espaciada para mejorar la memorizaci√≥n, y gamificaci√≥n para mantener la motivaci√≥n. Todos nuestros ejercicios est√°n dise√±ados siguiendo las √∫ltimas investigaciones sobre educaci√≥n para personas con dislexia.";
    } else {
      response = "Estoy aqu√≠ para ayudarte a entender mejor LearnToRead y c√≥mo puede beneficiar tu aprendizaje o el de tu hijo/a. Puedo explicarte sobre nuestros ejercicios, m√©todos de ense√±anza, c√≥mo interpretar el progreso, o resolver cualquier duda que tengas sobre la plataforma. ¬øHay algo espec√≠fico que te gustar√≠a saber?";
    }

    // Save the message and response to the database
    if (userId) {
      try {
        // Save user message
        await supabase.from('chat_messages').insert({
          user_id: userId,
          content: message,
          is_bot: false
        });

        // Save bot response
        await supabase.from('chat_messages').insert({
          user_id: userId,
          content: response,
          is_bot: true
        });

        // Save exercise suggestions if any
        if (suggestions.length > 0) {
          const suggestionInserts = suggestions.map(suggestion => ({
            user_id: userId,
            exercise_id: suggestion.id,
            reason: `Sugerido basado en tu consulta: "${message.substring(0, 50)}..."`
          }));

          await supabase.from('exercise_suggestions').insert(suggestionInserts);
        }
      } catch (error) {
        console.error("Error saving chat messages:", error);
      }
    }

    return new Response(
        JSON.stringify({
          message: response,
          suggestions
        }),
        {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
          status: 200
        }
    );
  } catch (error) {
    console.error("Error in chatbot-assistant function:", error);
    return new Response(
        JSON.stringify({ error: error.message || "Error interno del servidor" }),
        {
          headers: { ...corsHeaders, "Content-Type": "application/json" },
          status: 500
        }
    );
  }
});